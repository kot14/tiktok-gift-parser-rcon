<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>TikTok Gift Scripts</title>
    <style>
      body { font-family: Arial, sans-serif; margin: 20px; padding-bottom: 80px; }
      h1 { margin-bottom: 0; }
      .row { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px; }
      label { display: block; font-weight: 600; margin-bottom: 4px; }
      input, textarea, select { width: 100%; padding: 8px; box-sizing: border-box; }
      textarea { min-height: 120px; font-family: monospace; }
      button { padding: 8px 12px; cursor: pointer; }
      table { width: 100%; border-collapse: collapse; margin-top: 16px; }
      th, td { border: 1px solid #ccc; padding: 8px; vertical-align: top; }
      .actions { display: flex; gap: 8px; flex-wrap: wrap; }
      .pill { padding: 2px 6px; border-radius: 8px; background: #eef; font-size: 12px; }
      .error { color: #c00; font-weight: 600; }
      .success { color: #070; font-weight: 600; }
      .card { border: 1px solid #ddd; padding: 12px; border-radius: 8px; margin-top: 12px; }
      .sticky { position: fixed; bottom: 12px; right: 12px; background: #000; color: #fff; padding: 12px; border-radius: 8px; opacity: 0.9; }
      .muted { color: #555; font-size: 13px; }
      .gift-select-wrapper { position: relative; }
      .gift-select-input { width: 100%; padding: 8px; box-sizing: border-box; }
      .gift-select-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ccc; border-top: none; max-height: 200px; overflow-y: auto; z-index: 1000; display: none; }
      .gift-select-dropdown.show { display: block; }
      .gift-select-item { padding: 8px; cursor: pointer; border-bottom: 1px solid #eee; }
      .gift-select-item:hover { background: #f0f0f0; }
      .gift-select-item.selected { background: #e3f2fd; }
    </style>
  </head>
  <body>
    <h1>Gift scripts dashboard</h1>
    <p class="muted">–†–µ–¥–∞–≥—É–π –∫–æ–Ω—Ñ—ñ–≥, –¥–æ–¥–∞–≤–∞–π/—Ç–µ—Å—Ç—É–π —Å–∫—Ä–∏–ø—Ç–∏ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫—É —Å–µ—Ä–≤–µ—Ä–∞.</p>
    <div class="row">
      <div class="card">
        <h3>–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è</h3>
        <div class="actions" style="margin-bottom:8px;">
          <button id="btnStart">‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç</button>
          <button id="btnStop">‚èπ –°—Ç–æ–ø</button>
          <span id="status" class="muted"></span>
        </div>
        <label>TikTok username
          <input id="tiktokUsername" />
        </label>
        <label>sessionId
          <input id="sessionId" />
        </label>
        <label>Target player
          <input id="targetPlayer" />
        </label>
      </div>
      <div class="card">
        <h3>RCON</h3>
        <label>Host
          <input id="rconHost" />
        </label>
        <label>Port
          <input id="rconPort" type="number" />
        </label>
        <label>Password
          <input id="rconPassword" type="password" />
        </label>
      </div>
    </div>

    <div class="actions" style="margin-top:12px;">
      <button id="saveConfig">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –∫–æ–Ω—Ñ—ñ–≥</button>
      <span id="saveStatus" class="muted"></span>
    </div>

    <h3 style="margin-top:24px;">–°–∫—Ä–∏–ø—Ç–∏ –Ω–∞ –ø–æ–¥–∞—Ä—É–Ω–∫–∏</h3>
    <table>
      <thead>
        <tr><th>Gift name</th><th>–ù–∞–∑–≤–∞</th><th>–û–ø–∏—Å</th><th>–ö–æ–¥</th><th>–î—ñ—ó</th></tr>
      </thead>
      <tbody id="actionsTable"></tbody>
    </table>
    <button id="addAction" style="margin-top:12px;">‚ûï –î–æ–¥–∞—Ç–∏ —Å–∫—Ä–∏–ø—Ç</button>

    <div id="toast" class="sticky" style="display:none;"></div>
    <h3 style="margin-top:24px;">–õ–æ–≥–∏ —Ç—Ä–∞–Ω—Å–ª—è—Ü—ñ—ó</h3>
    <pre id="logs" style="min-height:120px;background:#111;color:#eee;padding:12px;max-height:240px;overflow:auto;border-radius:8px;"></pre>

    <script>
      const toastEl = document.getElementById("toast");
      const showToast = (msg, isError=false) => {
        toastEl.textContent = msg;
        toastEl.style.background = isError ? "#b00020" : "#000";
        toastEl.style.display = "block";
        setTimeout(() => toastEl.style.display = "none", 2500);
      };

      const api = async (path, options = {}) => {
        const res = await fetch(path, { headers: { "Content-Type": "application/json" }, ...options });
        if (!res.ok) {
          const body = await res.json().catch(() => ({}));
          throw new Error(body.error || res.statusText);
        }
        return res.json();
      };

      let state = null;
      let logs = [];
      let giftList = [];
      const TEMPLATES = {
        say: [
          "async ({ rcon, event, log }) => {",
          "  const msg = 'Hello ' + (event.nickname || event.uniqueId) + '!';",
          "  await rcon.send('/say ' + msg);",
          "  log('sent:', msg);",
          "}",
        ].join("\\n"),
        zombie: [
          "async ({ rcon, targetPlayer, log }) => {",
          "  // targetPlayer –¥–æ—Å—Ç—É–ø–Ω–∏–π –Ω–∞–ø—Ä—è–º—É –∑ –∫–æ–Ω—Ñ—ñ–≥—É",
          "  const cmd = '/execute as @a[name=' + targetPlayer + ',limit=1] at @s run summon zombie ~ ~1 ~';",
          "  await rcon.send(cmd);",
          "  log('zombie spawned');",
          "}",
        ].join("\\n"),
        give: [
          "async ({ rcon, targetPlayer, log }) => {",
          "  // –ú–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ targetPlayer –∞–±–æ config.targetPlayer",
          "  const cmd = '/give ' + targetPlayer + ' minecraft:diamond 1';",
          "  await rcon.send(cmd);",
          "  log('diamond given');",
          "}",
        ].join("\\n"),
        command: [
          "async ({ rcon, event, config, log }) => {",
          "  // –î–æ—Å—Ç—É–ø–Ω—ñ –∑–º—ñ–Ω–Ω—ñ: rcon, event, config, log, targetPlayer, rconConfig, tiktokUsername, sessionId",
          "  const raw = '/time set day'; // –∑–∞–º—ñ–Ω–∏ –Ω–∞ –ø–æ—Ç—Ä—ñ–±–Ω—É –∫–æ–º–∞–Ω–¥—É",
          "  const out = await rcon.send(raw);",
          "  log(out);",
          "}",
        ].join("\\n"),
      };

      const renderLogs = () => {
        const target = document.getElementById("logs");
        target.textContent = logs
          .slice()
          .reverse()
          .map((l) => {
            const time = new Date(l.ts).toLocaleTimeString();
            return `[${time}] [${l.type}] ${l.message}`;
          })
          .join("\\n");
      };

      const createGiftSelect = (idx, currentValue) => {
        const wrapper = document.createElement("div");
        wrapper.className = "gift-select-wrapper";
        wrapper.innerHTML = `
          <input 
            type="text" 
            class="gift-select-input" 
            data-field="giftName" 
            data-idx="${idx}"
            value="${currentValue || ''}"
            placeholder="üîç –ü–æ—à—É–∫ –ø–æ–¥–∞—Ä—É–Ω–∫–∞..."
            autocomplete="off"
          />
          <div class="gift-select-dropdown" data-idx="${idx}"></div>
        `;
        return wrapper;
      };

      const filterGifts = (searchTerm) => {
        if (!searchTerm) return giftList;
        const term = searchTerm.toLowerCase();
        return giftList.filter(gift => gift.toLowerCase().includes(term));
      };

      const renderGiftDropdown = (input, idx) => {
        const dropdown = input.parentElement.querySelector('.gift-select-dropdown');
        const searchTerm = input.value;
        const filtered = filterGifts(searchTerm);
        
        dropdown.innerHTML = filtered.length > 0
          ? filtered.map((gift, i) => 
              `<div class="gift-select-item" data-value="${gift}" data-index="${i}">${gift}</div>`
            ).join('')
          : '<div class="gift-select-item" style="color:#999;">–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</div>';
        
        dropdown.classList.add('show');
        // Reset selected index
        input.dataset.selectedIndex = '-1';
      };

      const hideGiftDropdown = (input) => {
        const dropdown = input.parentElement.querySelector('.gift-select-dropdown');
        dropdown.classList.remove('show');
      };

      const renderActions = () => {
        const tbody = document.getElementById("actionsTable");
        tbody.innerHTML = "";
        (state?.actions || []).forEach((action, idx) => {
          const tr = document.createElement("tr");
          const giftSelectCell = document.createElement("td");
          const giftSelect = createGiftSelect(idx, action.giftName);
          giftSelectCell.appendChild(giftSelect);
          
          tr.innerHTML = `
            <td><input data-field="name" data-idx="${idx}" value="${action.name || ""}"/></td>
            <td><input data-field="description" data-idx="${idx}" value="${action.description || ""}"/></td>
            <td><textarea data-field="code" data-idx="${idx}">${action.code || ""}</textarea>
              <div class="muted">–ü—Ä–∏–∫–ª–∞–¥: async ({ rcon, event, log, targetPlayer }) => {\\n  const cmd = \\\`/say hello \\\${event.uniqueId}\\\`;\\n  await rcon.send(cmd);\\n  log("done");\\n}</div>
              <div class="muted" style="margin-top:4px;">–î–æ—Å—Ç—É–ø–Ω—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏: rcon, event, config, log, targetPlayer, rconConfig, tiktokUsername, sessionId</div>
              <div style="margin:6px 0; display:flex; gap:6px; align-items:center;">
                <select data-idx="${idx}" data-field="template">
                  <option value="">–®–∞–±–ª–æ–Ω</option>
                  <option value="say">/say</option>
                  <option value="zombie">Spawn zombie</option>
                  <option value="give">Give diamond</option>
                  <option value="command">Custom command</option>
                </select>
                <button data-action="template" data-idx="${idx}">–í—Å—Ç–∞–≤–∏—Ç–∏</button>
              </div>
              ${action.error ? '<div class="error">' + action.error + '</div>' : ''}</td>
            <td class="actions">
              <button data-action="test" data-idx="${idx}">–¢–µ—Å—Ç</button>
              <button data-action="remove" data-idx="${idx}">–í–∏–¥–∞–ª–∏—Ç–∏</button>
            </td>
          `;
          tr.insertBefore(giftSelectCell, tr.firstChild);
          tbody.appendChild(tr);
          
          // Setup gift select events
          const giftInput = giftSelect.querySelector('.gift-select-input');
          const giftDropdown = giftSelect.querySelector('.gift-select-dropdown');
          
          giftInput.addEventListener('input', (e) => {
            renderGiftDropdown(e.target, idx);
            state.actions[idx].giftName = e.target.value;
          });
          
          giftInput.addEventListener('focus', (e) => {
            renderGiftDropdown(e.target, idx);
          });
          
          giftInput.addEventListener('blur', (e) => {
            setTimeout(() => hideGiftDropdown(e.target), 200);
          });
          
          giftInput.addEventListener('keydown', (e) => {
            const dropdown = giftDropdown;
            if (!dropdown.classList.contains('show')) return;
            
            const items = dropdown.querySelectorAll('.gift-select-item[data-value]');
            if (items.length === 0) return;
            
            let selectedIdx = parseInt(giftInput.dataset.selectedIndex || '-1');
            
            if (e.key === 'ArrowDown') {
              e.preventDefault();
              selectedIdx = Math.min(selectedIdx + 1, items.length - 1);
              giftInput.dataset.selectedIndex = selectedIdx;
              items[selectedIdx].scrollIntoView({ block: 'nearest' });
              items.forEach((item, i) => {
                item.classList.toggle('selected', i === selectedIdx);
              });
            } else if (e.key === 'ArrowUp') {
              e.preventDefault();
              selectedIdx = Math.max(selectedIdx - 1, -1);
              giftInput.dataset.selectedIndex = selectedIdx;
              if (selectedIdx >= 0) {
                items[selectedIdx].scrollIntoView({ block: 'nearest' });
                items.forEach((item, i) => {
                  item.classList.toggle('selected', i === selectedIdx);
                });
              }
            } else if (e.key === 'Enter' && selectedIdx >= 0) {
              e.preventDefault();
              const item = items[selectedIdx];
              if (item && item.dataset.value) {
                giftInput.value = item.dataset.value;
                state.actions[idx].giftName = item.dataset.value;
                hideGiftDropdown(giftInput);
              }
            } else if (e.key === 'Escape') {
              hideGiftDropdown(giftInput);
            }
          });
          
          giftDropdown.addEventListener('click', (e) => {
            const item = e.target.closest('.gift-select-item');
            if (item && item.dataset.value) {
              giftInput.value = item.dataset.value;
              state.actions[idx].giftName = item.dataset.value;
              hideGiftDropdown(giftInput);
            }
          });
          
          giftDropdown.addEventListener('mouseenter', (e) => {
            const item = e.target.closest('.gift-select-item');
            if (item && item.dataset.index) {
              const items = giftDropdown.querySelectorAll('.gift-select-item[data-value]');
              items.forEach((i, idx) => {
                i.classList.toggle('selected', idx === parseInt(item.dataset.index));
              });
              giftInput.dataset.selectedIndex = item.dataset.index;
            }
          });
        });
      };

      const bindTableEvents = () => {
        document.getElementById("actionsTable").addEventListener("input", (e) => {
          const idx = Number(e.target.dataset.idx);
          const field = e.target.dataset.field;
          if (Number.isInteger(idx) && field && field !== 'giftName') {
            state.actions[idx][field] = e.target.value;
          }
        });

        document.getElementById("actionsTable").addEventListener("change", (e) => {
          const idx = Number(e.target.dataset.idx);
          const field = e.target.dataset.field;
          if (Number.isInteger(idx) && field && field !== 'giftName') {
            state.actions[idx][field] = e.target.value;
          }
        });

        document.getElementById("actionsTable").addEventListener("click", async (e) => {
          const idx = Number(e.target.dataset.idx);
          const type = e.target.dataset.action;
          if (!Number.isInteger(idx)) return;
          if (type === "remove") {
            state.actions.splice(idx, 1);
            renderActions();
            return;
          }
          if (type === "template") {
            const select = e.target.parentElement?.querySelector('select[data-field="template"]');
            const tplKey = select?.value;
            if (tplKey && TEMPLATES[tplKey]) {
              state.actions[idx].code = TEMPLATES[tplKey];
              renderActions();
            }
            return;
          }
          if (type === "test") {
            try {
              const resp = await api("/api/actions/test", {
                method: "POST",
                body: JSON.stringify({ action: state.actions[idx] })
              });
              showToast("‚úÖ –¢–µ—Å—Ç –æ–∫. –õ–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª—ñ –±—Ä–∞—É–∑–µ—Ä–∞.");
              console.log("Test logs:", resp.logs);
            } catch (err) {
              showToast("‚ùå " + err.message, true);
            }
          }
        });
      };

      const loadGifts = async () => {
        try {
          giftList = await api("/api/gifts");
        } catch (err) {
          console.warn("Failed to load gifts:", err);
          giftList = [];
        }
      };

      const loadConfig = async () => {
        state = await api("/api/config");
        document.getElementById("tiktokUsername").value = state.tiktokUsername || "";
        document.getElementById("sessionId").value = state.sessionId || "";
        document.getElementById("targetPlayer").value = state.targetPlayer || "";
        document.getElementById("rconHost").value = state.rcon?.host || "";
        document.getElementById("rconPort").value = state.rcon?.port || "";
        document.getElementById("rconPassword").value = state.rcon?.password || "";
        renderActions();
      };

      const loadStatus = async () => {
        try {
          const s = await api("/api/status");
          document.getElementById("status").textContent = s.running ? "–ü—ñ–¥–∫–ª—é—á–µ–Ω–æ" : "–ù–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ";
          logs = s.logs || [];
          renderLogs();
        } catch (err) {
          console.warn(err);
        }
      };

      document.getElementById("saveConfig").addEventListener("click", async () => {
        const payload = {
          tiktokUsername: document.getElementById("tiktokUsername").value.trim(),
          sessionId: document.getElementById("sessionId").value.trim(),
          targetPlayer: document.getElementById("targetPlayer").value.trim(),
          rcon: {
            host: document.getElementById("rconHost").value.trim(),
            port: Number(document.getElementById("rconPort").value),
            password: document.getElementById("rconPassword").value
          },
          actions: state.actions
        };
        try {
          const saved = await api("/api/config", { method: "PUT", body: JSON.stringify(payload) });
          state = saved;
          renderActions();
          showToast("‚úÖ –ó–±–µ—Ä–µ–∂–µ–Ω–æ —ñ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–æ");
        } catch (err) {
          showToast("‚ùå " + err.message, true);
        }
      });

      document.getElementById("addAction").addEventListener("click", () => {
        state.actions.push({
          id: crypto.randomUUID(),
          name: "New action",
          description: "",
          giftName: "",
          code: "async ({ rcon, event, targetPlayer, log }) => {\\n  // –≤–∞—à –∫–æ–¥ —Ç—É—Ç\\n  // –î–æ—Å—Ç—É–ø–Ω—ñ: rcon, event, config, log, targetPlayer, rconConfig, tiktokUsername, sessionId\\n}"
        });
        renderActions();
      });

      document.getElementById("btnStart").addEventListener("click", async () => {
        try {
          await api("/api/start", { method: "POST" });
          showToast("–ó–∞–ø—É—â–µ–Ω–æ");
          await loadStatus();
        } catch (err) {
          showToast("‚ùå " + err.message, true);
        }
      });

      document.getElementById("btnStop").addEventListener("click", async () => {
        try {
          await api("/api/stop", { method: "POST" });
          showToast("–ó—É–ø–∏–Ω–µ–Ω–æ");
          await loadStatus();
        } catch (err) {
          showToast("‚ùå " + err.message, true);
        }
      });

      bindTableEvents();
      loadGifts().then(() => {
        loadConfig().catch((err) => showToast("–ù–µ –∑–º—ñ–≥ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏: " + err.message, true));
      });
      loadStatus();
      setInterval(loadStatus, 2000);
    </script>
    <div class="muted" style="margin-top:12px;">
      <strong>–ü–∞—Ä–∞–º–µ—Ç—Ä–∏ —É —Å–∫—Ä–∏–ø—Ç—ñ:</strong><br/>
      ‚Ä¢ <code>rcon</code> - RCON –∫–ª—ñ—î–Ω—Ç –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥<br/>
      ‚Ä¢ <code>event</code> - –¥–∞–Ω—ñ –ø–æ–¥—ñ—ó (giftName, uniqueId, nickname, repeatCount, giftType, repeatEnd)<br/>
      ‚Ä¢ <code>config</code> - –ø–æ–≤–Ω–∏–π –æ–±'—î–∫—Ç –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó<br/>
      ‚Ä¢ <code>log</code> - —Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è –ª–æ–≥—É–≤–∞–Ω–Ω—è<br/>
      ‚Ä¢ <code>targetPlayer</code> - —ñ–º'—è –≥—Ä–∞–≤—Ü—è –∑ –∫–æ–Ω—Ñ—ñ–≥—É (config.targetPlayer)<br/>
      ‚Ä¢ <code>rconConfig</code> - –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è RCON (config.rcon)<br/>
      ‚Ä¢ <code>tiktokUsername</code> - —ñ–º'—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ TikTok<br/>
      ‚Ä¢ <code>sessionId</code> - session ID –¥–ª—è TikTok<br/>
      <br/>
      <strong>–ü—Ä–∏–∫–ª–∞–¥:</strong> <code>async ({ rcon, targetPlayer, event, log }) => { await rcon.send('/give ' + targetPlayer + ' diamond 1'); }</code>
    </div>
  </body>
</html>

